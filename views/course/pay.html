<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

  <header>
    <nav class="bg-white border-b shadow">
      <div id="topNav" class="container mx-auto flex justify-between items-center py-4 px-2 lg:px-8">
        <img id="logo" src="../../static/img/headerlogo.png" alt="IT Learning Logo" class="w-35 h-12" />

        <button class="lg:hidden flex items-center px-3 py-2 border rounded text-gray-500 border-gray-400"
                type="button">
          <svg class="fill-current h-5 w-5" viewBox="0 0 20 20"><path d="M0 3h20v2H0V3zm0 5h20v2H0V8zm0 5h20v2H0v-2z"/></svg>
        </button>

        <div class="hidden lg:flex space-x-8 items-center">
          <ul class="flex space-x-6 text-gray-700 font-semibold">
            <li><a class="hover:text-blue-500" href="/">Home</a></li>
            <li><a class="hover:text-blue-500" href="aboutUs">About Us</a></li>
            <li class="relative group">
              <a class="hover:text-blue-500 flex items-center cursor-pointer">Browse
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </a>
              <ul class="absolute hidden group-hover:block bg-white shadow-lg rounded mt-1 text-sm">
                <li><a class="block px-4 py-2 hover:bg-gray-200" href="#">Browse Courses by Category</a></li>
                <li><a class="block px-4 py-2 hover:bg-gray-200" href="#">Browse Courses by Name</a></li>
                <li class="border-t"><a class="block px-4 py-2 hover:bg-gray-200" href="#">Browse Instructors</a></li>
              </ul>
            </li>
            <li><a class="hover:text-blue-500" href="pricing">Pricing</a></li>
            <li><a class="hover:text-blue-500" href="/">My Account</a></li>
            <li><a class="hover:text-blue-500" href="faq">FAQs</a></li>
            <li><a class="hover:text-blue-500" href="contactPage">Contact</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <div class="min-h-screen flex flex-col lg:flex-row">

    <div class="w-full lg:w-2/3 lg:pr-20 lg:pl-60 lg:pt-10 bg-white px-10 pt-10">

      <h1 class="text-xl font-bold mb-6">Checkout</h1>

      <div class="mb-6">
        <label class="block text-lg font-semibold mb-2">Billing Address</label>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-600 pb-4">Country</label>
          <select class="block w-full p-3 border border-black focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option>Vietnam</option>
            <option>United States</option>
            <option>Canada</option>
            <option>Australia</option>
          </select>
        </div>
        <p class="text-sm text-gray-500">ITLearning is required by law to collect applicable transaction taxes for purchases made in certain tax jurisdictions.</p>
      </div>

      <div class="mb-8">
        <label class="block text-xl font-semibold mb-4">Payment Method</label>
        <div class="flex items-center mb-1 border border-gray-300 p-3">
          <input id="card" name="payment-method" type="radio" value="VISA" class="form-radio h-5 w-5 text-blue-600">
          <label for="card" class="ml-3 text-lg font-medium">Credit/Debit Card</label>
          <div class="ml-auto flex space-x-2">
            <img class="h-10" src="https://cdn.iconscout.com/icon/free/png-256/visa-3-226460.png" alt="Visa">
            <img class="h-10" src="https://cdn.iconscout.com/icon/free/png-256/mastercard-12-226436.png" alt="MasterCard">
            <img class="h-10" src="https://cdn.iconscout.com/icon/free/png-256/amex-226419.png" alt="Amex">
          </div>
        </div>
        <div class="flex items-center border border-gray-300 p-3">
          <input id="paypal" name="payment-method" type="radio" value="PayPal" class="form-radio h-5 w-5 text-blue-600">
          <label for="paypal" class="ml-3 text-lg font-medium">PayPal</label>
          <div class="ml-auto">
            <img class="h-6" src="https://cdn.iconscout.com/icon/free/png-256/paypal-3-226454.png" alt="PayPal">
          </div>
        </div>
      </div>

      <div id="order-details"></div>

    </div>

    <div id="summary" class="w-full lg:w-1/3 bg-white lg:bg-gray-100 lg:pl-20 lg:pr-40 lg:pt-10 px-10 pt-10"></div>

  </div>

  <script>
    const apiBaseUrl = 'http://localhost:3000';
    const learnerId = '66e07cb88a0cafe880f72d44';

    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        courseId: params.get('courseId'),
        instructorId: params.get('instructorId'),
        courseName: params.get('courseName'),
        price: params.get('price'),
        imgUrl: params.get('courseImg')
      };
    }

    function formatPrice(price) {
      let formattedPrice = price.toLocaleString('vi-VN');
      if (Number.isInteger(parseFloat(price))) {
        formattedPrice += '.000 vnđ';
      }
      return formattedPrice;
    }

    function loadCheckoutData() {
      const { courseName, price, imgUrl, courseId } = getQueryParams();
      const formattedPrice = formatPrice(parseFloat(price));

      document.getElementById('order-details').innerHTML = `
        <h2 class="text-2xl font-semibold mb-4">Order Details</h2>
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <img class="h-10 w-10 rounded-md" src="${imgUrl}" alt="Course Thumbnail">
            <div class="ml-4">
              <h3 class="text-lg font-semibold">${courseName}</h3>
            </div>
          </div>
          <span class="text-lg">${formattedPrice}</span>
        </div>
      `;

      document.getElementById('summary').innerHTML = `
        <h2 class="text-xl font-bold mb-6">Summary</h2>
        <div class="flex justify-between mb-4">
          <span class="text-gray-700 text-lg">Original Price:</span>
          <span class="font-medium text-lg text-gray-700">${formattedPrice} đ</span>
        </div>
        <div class="flex justify-between mb-6">
          <span class="text-lg font-semibold text-gray-700">Total:</span>
          <span class="text-lg font-semibold text-gray-700">${formattedPrice} đ</span>
        </div>
        <p class="text-sm text-gray-500 mb-6">By completing your purchase, you agree to these <a href="#" class="text-blue-600 underline">Terms of Service</a>.</p>
        <button id="completeCheckoutBtn" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-lg hover:bg-purple-700 transition">
          Complete Checkout
        </button>
        <p class="text-center text-sm text-gray-500 mt-4">30-Day Money-Back Guarantee</p>
      `;
    }

    async function handleCheckout() {
      const { courseId, instructorId } = getQueryParams();
      const price = parseFloat(new URLSearchParams(window.location.search).get('price'));

      const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
      if (!paymentMethod) {
        alert('Please select a payment method.');
        return;
      }

      const transactionData = {
        learnerId,
        courseId,
        instructorId,
        amount: price,
        transactionDate: new Date().toISOString(),
        paymentMethod: paymentMethod.value // Ensure this is a string
      };

      try {
        const response = await fetch(`${apiBaseUrl}/api/transactions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(transactionData),
        });

        if (!response.ok) {
          // Log response body for debugging
          const errorText = await response.text();
          console.error(`HTTP error! status: ${response.status}, message: ${errorText}`);
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        alert(`Checkout successful! ${data.message}`);
      } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
        alert('Checkout failed. Please try again.');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCheckoutData();
      document.getElementById('completeCheckoutBtn').addEventListener('click', handleCheckout);
    });
  </script>

</body>
</html>
